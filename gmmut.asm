 PRAGMA autobranchlength
 org $6000
input rmb 1
output rmb 1
start
 lda input
 cmpa #3
 beq count_mmu_blocks
 cmpa #6
 beq vdg_wrap
# nothing to do exit.
 rts

count_mmu_blocks
 bsr turn_off_ints
 bsr save_task_0
# Put mmu block number
# in first byte of each block
 clrb
 ldx #buffer2
count_bocks_loop
 stb $ffa0
 lda >$0
 sta ,x+
 stb >$0
 incb
 bne count_bocks_loop
# fill buffer with what is
# left in the first byte of each block
 clrb
 ldx #buffer
count_loop
 stb $ffa0
 lda >$0
 sta ,x+
 incb
 bne count_loop
# report first byte of buffer
 lda buffer
 sta output
# fix up overwritten bytes
 clrb
 ldx #buffer2
restore_loop
 stb $ffa0
 lda ,x+
 sta >$0
 incb
 bne restore_loop
 bsr restore_task_0
 bsr turn_on_ints
 rts 

vdg_wrap
 bsr turn_off_ints
# Initialize CoCo Mem Jr.'s MMU
 lda $ffa0
 anda #%00111111
 bne init_gime
# Change to all ram mode
 sta $ffdf
# Initialize mmu banks
 ldb #7
 ldx #$ffa1
mmu_init_loop
 inca
 sta ,x+
 decb
 bne mmu_init_loop
init_gime
 lda #$cc
 sta $ff90
 
# set SAM to highest base address ($FE00)
# for video
 lda #%01111111
 bsr store_a_into_sam_offset
 
 lda #$3f
 sta $ffa0
 bsr write_string
 fdb $1e00+(12*32)
 fcn "Page: 3f, Offset: 1e00 "
 
 lda #$00
 sta $ffa0
 bsr write_string
 fdb $0000+(12*32)
 fcn "Page: 00, Offset: 0000 "
 
 lda #$38
 sta $ffa0
 bsr write_string
 fdb $0000+(12*32)
 fcn "Page: 38, Offset: 0000 "
 
 lda #$40
 sta $ffa0
 bsr write_string
 fdb $0000+(12*32)
 fcn "Page: 40, Offset: 0000 "

loop bra loop

 clra
 pshs a
loop_a
 lda ,s
 tfr a,b
 andb #%00111111
 cmpb #$3b
 beq skip
 sta $ffa0
 ldx #hex
 lsra
 lsra
 lsra
 lsra
 lda a,x
 sta string+6
 sta string1+6
 lda ,s
 anda #%00001111 
 lda a,x
 sta string+7
 sta string1+7

 bsr write_string
 fdb $0000+(12*32)
string
 fcn "Page: XX, Offset: 0000 "
 
 bsr write_string
 fdb $1000+(12*32)
string1
 fcn "Page: XX, Offset: 1000 "
 
skip
 inc ,s
 bne loop_a

# show all pages
 clr ,s
loop_show_pages
 lda ,s
 bsr store_a_into_sam_offset
 ldx #0
delay_loop
 leax 1,x
 bne delay_loop
 inc ,s
 bra loop_show_pages
 
wait jmp wait

hex fcc "0123456789abcdef"

write_string
 puls u
 ldy ,u++
write_string_loop
 lda ,u+
 beq write_string_done
 suba #32
 bsr write_character
 leay (13*32)+1,y
 bra write_string_loop
write_string_done
 tfr u,pc

write_character
 ldx #bitmap_font
 ldb #13
 mul
 leax d,x
 ldb #13
write_character_loop
 lda ,x+
 coma
 sta ,y
 leay -32,y
 decb
 bne write_character_loop
 rts

vdg_wait
# Set bank zero to first VDG page
 lda #$3f-8
 sta $ffa0
# Set bank one to page after 64k
 lda #$3f+1
 sta $ffa1
# save three bytes, and set
# their initial value
 lda >$0
 sta saved_bytes+0
 clr >$0
 lda $2000
 sta saved_bytes+1
 lda $fe00
 sta saved_bytes+2
 lda #$ff
 sta $2000
 sta $fe00
 ldx #0
 ldb #15
vdg_loop
 leax 1,x
 bne vdg_loop
 com >$0
 com $2000
 com $fe00
 decb
 bne vdg_loop

# restore memory values
 lda saved_bytes+0
 sta >$0
 lda saved_bytes+1
 sta $2000
 lda saved_bytes+2
 sta $fe00

# restore mmu banks
 bsr restore_task_0
 bsr turn_on_ints

# return
 rts
saved_task rmb 8
saved_bytes rmb 3
 
#
# subroutine
# Store reg a into sam video offset register
#
store_a_into_sam_offset
 ldb #7
 ldx #$ffc6
loop_store_a
 rora
 bcc set_clear
set_set
 leax 1,x
 sta ,x+
 bra set_done
set_clear
 sta ,x++
set_done 
 decb
 bne loop_store_a
 rts

#
# subroutine
# turn off all interrupts
#
turn_off_ints
# turn off pia0 ints
 clra
 sta $ff01
 sta $ff03
# turn off pia1 ints
 clra
 sta $ff21
 sta $ff23
# turn off gime ints
 lda #$cc
 anda #%11001111
 sta $ff90
 rts

#
# subroutine
# turn on all interrupts
#
turn_on_ints
# turn on pia0 ints
 lda #$34
 sta $ff01
 lda #$b5
 sta $ff03
# turn on pia1 ints
 lda #$34
 sta $ff21
 lda #$37
 sta $ff23
# reset gime
 lda #$cc
 sta $ff90
 rts
 
restore_task_0
#
# subroutine
# restore mmu regs at ffa0
#
 ldy #saved_task
 ldx #$ffa0
 bra copy_task
 
save_task_0
#
# subroutine
# save mmu regs at ffa0
#
 ldy #$ffa0
 ldx #saved_task
copy_task
 ldd ,y++
 std ,x++
 ldd ,y++
 std ,x++
 ldd ,y++
 std ,x++
 ldd ,y++
 std ,x++
 rts

buffer rmb 256
buffer2 rmb 256
bitmap_font
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 # space :32
 fcb 0x00,0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18 # !     :33
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x36,0x36,0x36,0x36
 fcb 0x00,0x00,0x00,0x66,0x66,0xff,0x66,0x66,0xff,0x66,0x66,0x00,0x00
 fcb 0x00,0x00,0x18,0x7e,0xff,0x1b,0x1f,0x7e,0xf8,0xd8,0xff,0x7e,0x18
 fcb 0x00,0x00,0x0e,0x1b,0xdb,0x6e,0x30,0x18,0x0c,0x76,0xdb,0xd8,0x70
 fcb 0x00,0x00,0x7f,0xc6,0xcf,0xd8,0x70,0x70,0xd8,0xcc,0xcc,0x6c,0x38
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x1c,0x0c,0x0e
 fcb 0x00,0x00,0x0c,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0c
 fcb 0x00,0x00,0x30,0x18,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x18,0x30
 fcb 0x00,0x00,0x00,0x00,0x99,0x5a,0x3c,0xff,0x3c,0x5a,0x99,0x00,0x00
 fcb 0x00,0x00,0x00,0x18,0x18,0x18,0xff,0xff,0x18,0x18,0x18,0x00,0x00
 fcb 0x00,0x00,0x30,0x18,0x1c,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x00,0x38,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 fcb 0x00,0x60,0x60,0x30,0x30,0x18,0x18,0x0c,0x0c,0x06,0x06,0x03,0x03
 fcb 0x00,0x00,0x3c,0x66,0xc3,0xe3,0xf3,0xdb,0xcf,0xc7,0xc3,0x66,0x3c
 fcb 0x00,0x00,0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x78,0x38,0x18
 fcb 0x00,0x00,0xff,0xc0,0xc0,0x60,0x30,0x18,0x0c,0x06,0x03,0xe7,0x7e
 fcb 0x00,0x00,0x7e,0xe7,0x03,0x03,0x07,0x7e,0x07,0x03,0x03,0xe7,0x7e
 fcb 0x00,0x00,0x0c,0x0c,0x0c,0x0c,0x0c,0xff,0xcc,0x6c,0x3c,0x1c,0x0c
 fcb 0x00,0x00,0x7e,0xe7,0x03,0x03,0x07,0xfe,0xc0,0xc0,0xc0,0xc0,0xff
 fcb 0x00,0x00,0x7e,0xe7,0xc3,0xc3,0xc7,0xfe,0xc0,0xc0,0xc0,0xe7,0x7e
 fcb 0x00,0x00,0x30,0x30,0x30,0x30,0x18,0x0c,0x06,0x03,0x03,0x03,0xff
 fcb 0x00,0x00,0x7e,0xe7,0xc3,0xc3,0xe7,0x7e,0xe7,0xc3,0xc3,0xe7,0x7e
 fcb 0x00,0x00,0x7e,0xe7,0x03,0x03,0x03,0x7f,0xe7,0xc3,0xc3,0xe7,0x7e
 fcb 0x00,0x00,0x00,0x38,0x38,0x00,0x00,0x38,0x38,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x30,0x18,0x1c,0x1c,0x00,0x00,0x1c,0x1c,0x00,0x00,0x00
 fcb 0x00,0x00,0x06,0x0c,0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x0c,0x06
 fcb 0x00,0x00,0x00,0x00,0xff,0xff,0x00,0xff,0xff,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x60,0x30,0x18,0x0c,0x06,0x03,0x06,0x0c,0x18,0x30,0x60
 fcb 0x00,0x00,0x18,0x00,0x00,0x18,0x18,0x0c,0x06,0x03,0xc3,0xc3,0x7e
 fcb 0x00,0x00,0x3f,0x60,0xcf,0xdb,0xd3,0xdd,0xc3,0x7e,0x00,0x00,0x00
 fcb 0x00,0x00,0xc3,0xc3,0xc3,0xc3,0xff,0xc3,0xc3,0xc3,0x66,0x3c,0x18
 fcb 0x00,0x00,0xfe,0xc7,0xc3,0xc3,0xc7,0xfe,0xc7,0xc3,0xc3,0xc7,0xfe
 fcb 0x00,0x00,0x7e,0xe7,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xe7,0x7e
 fcb 0x00,0x00,0xfc,0xce,0xc7,0xc3,0xc3,0xc3,0xc3,0xc3,0xc7,0xce,0xfc
 fcb 0x00,0x00,0xff,0xc0,0xc0,0xc0,0xc0,0xfc,0xc0,0xc0,0xc0,0xc0,0xff
 fcb 0x00,0x00,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xfc,0xc0,0xc0,0xc0,0xff
 fcb 0x00,0x00,0x7e,0xe7,0xc3,0xc3,0xcf,0xc0,0xc0,0xc0,0xc0,0xe7,0x7e
 fcb 0x00,0x00,0xc3,0xc3,0xc3,0xc3,0xc3,0xff,0xc3,0xc3,0xc3,0xc3,0xc3
 fcb 0x00,0x00,0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7e
 fcb 0x00,0x00,0x7c,0xee,0xc6,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06
 fcb 0x00,0x00,0xc3,0xc6,0xcc,0xd8,0xf0,0xe0,0xf0,0xd8,0xcc,0xc6,0xc3
 fcb 0x00,0x00,0xff,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0
 fcb 0x00,0x00,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xdb,0xff,0xff,0xe7,0xc3
 fcb 0x00,0x00,0xc7,0xc7,0xcf,0xcf,0xdf,0xdb,0xfb,0xf3,0xf3,0xe3,0xe3
 fcb 0x00,0x00,0x7e,0xe7,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xe7,0x7e
 fcb 0x00,0x00,0xc0,0xc0,0xc0,0xc0,0xc0,0xfe,0xc7,0xc3,0xc3,0xc7,0xfe
 fcb 0x00,0x00,0x3f,0x6e,0xdf,0xdb,0xc3,0xc3,0xc3,0xc3,0xc3,0x66,0x3c
 fcb 0x00,0x00,0xc3,0xc6,0xcc,0xd8,0xf0,0xfe,0xc7,0xc3,0xc3,0xc7,0xfe
 fcb 0x00,0x00,0x7e,0xe7,0x03,0x03,0x07,0x7e,0xe0,0xc0,0xc0,0xe7,0x7e
 fcb 0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0xff
 fcb 0x00,0x00,0x7e,0xe7,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3
 fcb 0x00,0x00,0x18,0x3c,0x3c,0x66,0x66,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3
 fcb 0x00,0x00,0xc3,0xe7,0xff,0xff,0xdb,0xdb,0xc3,0xc3,0xc3,0xc3,0xc3
 fcb 0x00,0x00,0xc3,0x66,0x66,0x3c,0x3c,0x18,0x3c,0x3c,0x66,0x66,0xc3
 fcb 0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x3c,0x3c,0x66,0x66,0xc3
 fcb 0x00,0x00,0xff,0xc0,0xc0,0x60,0x30,0x7e,0x0c,0x06,0x03,0x03,0xff
 fcb 0x00,0x00,0x3c,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3c
 fcb 0x00,0x03,0x03,0x06,0x06,0x0c,0x0c,0x18,0x18,0x30,0x30,0x60,0x60
 fcb 0x00,0x00,0x3c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x3c
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc3,0x66,0x3c,0x18
 fcb 0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x38,0x30,0x70
 fcb 0x00,0x00,0x7f,0xc3,0xc3,0x7f,0x03,0xc3,0x7e,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xfe,0xc3,0xc3,0xc3,0xc3,0xfe,0xc0,0xc0,0xc0,0xc0,0xc0
 fcb 0x00,0x00,0x7e,0xc3,0xc0,0xc0,0xc0,0xc3,0x7e,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x7f,0xc3,0xc3,0xc3,0xc3,0x7f,0x03,0x03,0x03,0x03,0x03
 fcb 0x00,0x00,0x7f,0xc0,0xc0,0xfe,0xc3,0xc3,0x7e,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x30,0x30,0x30,0x30,0x30,0xfc,0x30,0x30,0x30,0x33,0x1e
 fcb 0x7e,0xc3,0x03,0x03,0x7f,0xc3,0xc3,0xc3,0x7e,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xfe,0xc0,0xc0,0xc0,0xc0
 fcb 0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x18,0x00
 fcb 0x38,0x6c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x00,0x00,0x0c,0x00
 fcb 0x00,0x00,0xc6,0xcc,0xf8,0xf0,0xd8,0xcc,0xc6,0xc0,0xc0,0xc0,0xc0
 fcb 0x00,0x00,0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x78
 fcb 0x00,0x00,0xdb,0xdb,0xdb,0xdb,0xdb,0xdb,0xfe,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xfc,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00
 fcb 0xc0,0xc0,0xc0,0xfe,0xc3,0xc3,0xc3,0xc3,0xfe,0x00,0x00,0x00,0x00
 fcb 0x03,0x03,0x03,0x7f,0xc3,0xc3,0xc3,0xc3,0x7f,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xc0,0xc0,0xc0,0xc0,0xc0,0xe0,0xfe,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xfe,0x03,0x03,0x7e,0xc0,0xc0,0x7f,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x1c,0x36,0x30,0x30,0x30,0x30,0xfc,0x30,0x30,0x30,0x00
 fcb 0x00,0x00,0x7e,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x18,0x3c,0x3c,0x66,0x66,0xc3,0xc3,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xc3,0xe7,0xff,0xdb,0xc3,0xc3,0xc3,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xc3,0x66,0x3c,0x18,0x3c,0x66,0xc3,0x00,0x00,0x00,0x00
 fcb 0xc0,0x60,0x60,0x30,0x18,0x3c,0x66,0x66,0xc3,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0xff,0x60,0x30,0x18,0x0c,0x06,0xff,0x00,0x00,0x00,0x00
 fcb 0x00,0x00,0x0f,0x18,0x18,0x18,0x38,0xf0,0x38,0x18,0x18,0x18,0x0f
 fcb 0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18
 fcb 0x00,0x00,0xf0,0x18,0x18,0x18,0x1c,0x0f,0x1c,0x18,0x18,0x18,0xf0
 fcb 0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x8f,0xf1,0x60,0x00,0x00,0x00

max_program equ *
 IFGT max_program-$7fff
 ERROR "Program to large"
 ENDC

 end start
 
 
 
 


